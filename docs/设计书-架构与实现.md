# 设计书（交互笔记）架构与实现

目标：把不同主题（3D、图文、练习）组织成一本可持续完善的“设计书”。左侧是目录导航，中间是内容区，右侧是该主题的控制面板。

## 运行方式

- 直接打开 `index.html` 即可。
- 如果浏览器限制 `file://` 下的模块加载，可在仓库根目录运行 `python3 -m http.server 8000`，访问 `http://localhost:8000/`。

## 当前目录结构（为“多项目 + 多主题”做准备）

- `index.html`：应用壳（布局、importmap、加载入口脚本）。
- `src/styles.css`：壳层 UI（侧边栏、面板、顶部工具栏、目录样式）。
- `src/designbook-kit.js`：全局复用工具（storage/随机数/文本转义/一次性注入 CSS/等待 three-ready 等），用于减少各主题重复代码。
- `src/app.js`：路由、项目/主题目录渲染、主题挂载/卸载、面板/目录折叠状态。
- `src/registry.js`：项目与主题注册表（新增主题只需在这里追加一项）。
- `src/projects/<projectId>/topics/<topicId>/topic.js`：主题模块（各自独立，负责内容区与面板区的渲染与交互）。

说明：主题只有一层（topicId），不强制“章节/小节”两级；如未来需要分类，可以在 `registry.js` 里用字段做 UI 分组，但不改变主题文件结构。

## 路由约定

- URL Hash 形式：`#/<projectId>/<topicId>`
- 例：`#/color-models/rgb-cube`

## 主题模块约定（必须）

每个主题模块需要在加载后注册自己：

- `window.DesignBook.registerModule("<projectId>/<topicId>", { mount })`

主题内可直接复用：

- `window.DesignBookKit`：共享工具（见 `src/designbook-kit.js`），避免每个主题重复实现 `clamp`/随机种子/localStorage 读写/样式注入等。

其中 `api` 由壳层提供：

- `contentEl`：中间内容容器（主题把 3D 画布/图文插入这里）。
- `panelEl`：右侧面板内容容器（主题把滑竿/开关/说明插入这里）。
- `actionsEl`：顶部工具栏中间区域（主题可塞“重置视角”等按钮）。
- `setPanelTitle(title)`：设置右侧面板标题。
- `setPanelCollapsed(bool)` / `setSidebarCollapsed(bool)`：如果主题希望主动控制壳层折叠，可用它们。

`mount()` 返回一个 `unmount()`（函数）用于清理资源（事件监听、RAF、WebGL 资源等）。壳层切换主题时会调用。

## RGB 主题（`rgb-cube`）实现思路记录

主题文件：`src/projects/color-models/topics/rgb-cube/topic.js`

核心映射：

- 立方体坐标：`x,y,z ∈ [-0.5, 0.5]`
- 颜色点位置：`pos = (r/255-0.5, g/255-0.5, b/255-0.5)`
- 灰度线：`R=G=B` 的对角线（黑→白）

可视化组件：

- 立方体表面：顶点色（RGB）+ 半透明。
- 颜色点：球体，位置随滑竿变化。
- 补色点：`(255-R, 255-G, 255-B)`，可开关显示，并用线连接。
- 体积点云：用 `Points + sprite` 做更“像体积”的 RGB 空间（默认关闭）。
- 灰度线：为避免 WebGL 线宽限制，使用 `TubeGeometry` 做“粗线”，并沿对角线做黑→白渐变；提供“灰度线专注”模式弱化其它元素。
- RGB / CMY 三角平面：两个可独立开关的三角面，帮助把 RGB 与 CMY 作为两组理解。
- 顶点标签：用 `CanvasTexture + Sprite` 做文字标签；使用 mipmaps/各向异性过滤/premultiplied alpha 改善边缘与缩放锯齿。
- 撞色连线：用 3D 圆柱做 R↔C、G↔M、B↔Y 的渐变连线（可开关）。

颜色管理（Three.js）：

- `renderer.outputColorSpace = THREE.SRGBColorSpace`
- `renderer.toneMapping = THREE.NoToneMapping`
- 所有 `Color.setRGB()` 都显式传入 `THREE.SRGBColorSpace`，避免颜色空间默认值导致的偏差。

已踩坑记录：

- WebGL `LineBasicMaterial.linewidth` 在大多数平台无效：用 `TubeGeometry` 替代“粗线”。
- 浏览器会恢复表单控件状态：主题面板由 JS 动态生成可避免“刷新仍勾选”的问题。

## 新增主题（推荐流程）

1. 新建文件 `src/projects/<projectId>/topics/<topicId>/topic.js`，实现 `mount()`。
2. 在 `src/registry.js` 的对应项目下追加：
   - `id`
   - `title`
   - `key: "<projectId>/<topicId>"`
   - `entry: "./src/projects/<projectId>/topics/<topicId>/topic.js"`
   - （可选）`needsThree: true`：如果主题依赖 Three.js（3D 相关），用于让壳层在加载主题前等待 `three-ready`。
3. 刷新 `index.html`，目录会自动出现新主题条目。
